function refresh_user_list(e, t) {
    filter.type = e, filter.page = 0, page = 0, user_list = {}, $(".user-filter-item.active").removeClass("active"), $(t).parent().addClass("active"), $(".user_panel .user-list").empty(), load_user_list()
}

function load_user_list() {
    loading || page != filter.page || (console.info("loading"), loading = !0, $(".loading").show(), $.post(go_moreUsers, filter, function (e) {
        e.count && (filter.page++, page++, render_user_list(e.list)), loading = !1, $(".loading").hide()
    }, "json"))
}

function render_user_list(e) {
    var t = $(".user-rows:last-child");
    cnt = t.find(".user-item").length;
    for (var i = 0; i < e.length; i++) {
        var l = e[i];
        if (void 0 == user_list[l.uid] && (user_list[l.uid] = l, cnt % 3 == 0 && (null != t && $(".user_panel .user-list").append(t), t = $('<div class="user-rows"></div>')), null != l.avatar && "" != l.avatar)) {
            l.avatar.indexOf("/") ? l.avatar = l.avatar.replace("/0", "/132") : l.avatar += "/132";
            var a = '<div class="user-item ' + l.sex + '" data-id="' + l.uid + '" onclick="express_love(this)"><div class="avatar" style="background-image: url(\'' + l.avatar + '\')"></div><div class="user-info"><div class="nickname">' + l.nickname + "</div></div></div>";
            $(t).append(a), cnt++
        }
    }
    "" != $(t).html() && ($(".user_panel .user-list").append(t), t = null)
}

function express_love(e) {
    lover.uid = $(e).attr("data-id"), $(".el-lover-name").text(user_list[lover.uid].nickname), $(".el_panel").show()
}

function express_love_direct(e) {
    lover.uid = e.uid, $(".el-lover-name").text(e.nickname), $(".el_panel").show()
}

var user_list = {}, loading = !1, filter = {type: 0, page: 0}, page = 0, lover = {};

$(function () {

    function e(e) {
        var t = $(this).scrollTop(), i = $(document).height(), l = $(this).height();
        $(".user-filter").height();
        t + l + 200 >= i && load_user_list()
    }

    $(window).scroll(e);

    $(".fl-el-item").click(function () {
        var e = $(this).attr("data-content"), t = $(this).attr("data-image");
        lover.theme_id = $(this).attr("data-id"), $("#love_letter").text(e), "" == $("#image").val() && ($("#image").val(t), "http://91youyu.oss-cn-shenzhen.aliyuncs.com/static/express_love/images/image_default.png" != t && $(".el-image-preview").attr("src", t + "?x-oss-process=style/thum")), $(".fl-el-item.selected").removeClass("selected"), $(this).addClass("selected")
    });
    $(".el-item-option").click(function () {
        lover.item_id = $(this).attr("data-id");
        var e = $(this).attr("data-fee");
        e = parseFloat(e), $(".el-price").text(e.toFixed(2)), $(".el-item-option.selected").removeClass("selected"), $(this).addClass("selected")
    });
    $(".close,#el-back-btn").click(function () {
        $(".el_panel").hide(), lover.uid = 0
    });
    $("#el-confirm-btn").click(function () {

        lover.love_letter = $("#love_letter").val();

        lover.image = $("#image").val();

        var e = "";

        if (lover.uid = parseInt(lover.uid), lover.item_id = parseInt(lover.item_id), lover.theme_id = parseInt(lover.theme_id), (isNaN(lover.uid) || lover.uid < 0) && (e += "-请选择表白对象<br/>"), (isNaN(lover.theme_id) || lover.theme_id <= 0) && (e += "-请选择表白主题<br/>"), "" == lover.image && (e += "-请选择图片<br/>"), "" == lover.love_letter && (e += "-请填写表白内容<br/>"), (isNaN(lover.item_id) || lover.item_id <= 0) && (e += "-请选择霸屏时长<br/>"), $("#bp-field-admin").length && (lover.admin_el = $("#bp-field-admin").prop("checked")), "" == e) {

            var t = document.createElement("form");

            t.action = express_love_form_url, t.method = "post";

            for (var i in lover) {

                var l = document.createElement("input");

                l.type = "hidden", l.value = lover[i], l.name = i, t.appendChild(l)
            }
            var a = document.createElement("input");
            a.type = "hidden", a.value = token, a.name = "token", t.appendChild(a), t.submit()
        } else $.alert(e)
    })
});